name: Build BrowserOS Flatpak from .deb

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest BrowserOS release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.getLatestRelease({
              owner: 'browseros-ai',
              repo: 'BrowserOS'
            });
            const deb = data.assets.find(a => a.name.endsWith('.deb'));
            if (!deb) core.setFailed('No .deb asset found');
            core.setOutput('version', data.tag_name.replace(/^v/, ''));
            core.setOutput('deb_url', deb.browser_download_url);

      - name: Skip if already released
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `v${{ steps.release.outputs.version }}-flatpak`;
            const { data } = await github.rest.repos.listReleases({ owner: context.repo.owner, repo: context.repo.repo });
            core.setOutput('skip', data.some(r => r.tag_name === tag));

      - name: Download .deb
        if: steps.check.outputs.skip != 'true'
        run: curl -L -o browseros.deb "${{ steps.release.outputs.deb_url }}"

      - name: Install tools
        if: steps.check.outputs.skip != 'true'
        run: |
          sudo apt update
          sudo apt install -y flatpak flatpak-builder binutils zstd

      - name: Setup Flatpak (user mode)
        if: steps.check.outputs.skip != 'true'
        run: |
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//25.08 org.freedesktop.Sdk//25.08

      # Extract and create a clean tarball with correct structure
      - name: Extract and prepare app bundle
        if: steps.check.outputs.skip != 'true'
        run: |
          ar x browseros.deb data.tar.zst
          zstd -d --stdout data.tar.zst | tar -xf -

          # Create proper export directory for desktop integration
          mkdir -p export/share/applications
          mkdir -p export/share/icons/hicolor/256x256/apps

          # Fix desktop file
          sed 's/^Name=.*/Name=BrowserOS AI/' \
              usr/share/applications/browseros.desktop \
              > export/share/applications/com.nodemixaholic.BrowserOSFlatpak.desktop

          # Fix icon
          cp usr/share/icons/hicolor/256x256/apps/browseros.png \
             export/share/icons/hicolor/256x256/apps/com.nodemixaholic.BrowserOSFlatpak.png

          # Create clean tarball: usr/ → app/
          tar -czf app-contents.tar.gz \
            --transform='s|^usr|app|' \
            usr/bin usr/lib usr/share

      - name: Create final Flatpak manifest
        if: steps.check.outputs.skip != 'true'
        run: |
          cat > com.nodemixaholic.BrowserOSFlatpak.json << 'EOF'
          {
            "id": "com.nodemixaholic.BrowserOSFlatpak",
            "runtime": "org.freedesktop.Platform",
            "runtime-version": "25.08",
            "sdk": "org.freedesktop.Sdk",
            "command": "browseros",
            "finish-args": [
              "--share=ipc",
              "--share=network",
              "--socket=fallback-x11",
              "--socket=wayland",
              "--device=dri",
              "--socket=pulseaudio",
              "--filesystem=home",
              "--filesystem=host",
              "--talk-name=org.freedesktop.secrets",
              "--device=shm"
            ],
            "modules": [
              {
                "name": "browseros",
                "buildsystem": "simple",
                "build-commands": [
                  "tar -xzf app-contents.tar.gz -C /",
                  "chmod +x /app/bin/browseros",
                  "ln -sf browseros /app/bin/BrowserOS"
                ],
                "sources": [
                  {
                    "type": "file",
                    "path": "app-contents.tar.gz"
                  },
                  {
                    "type": "file",
                    "path": "export/share/applications/com.nodemixaholic.BrowserOSFlatpak.desktop",
                    "dest": "share/applications/"
                  },
                  {
                    "type": "file",
                    "path": "export/share/icons/hicolor/256x256/apps/com.nodemixaholic.BrowserOSFlatpak.png",
                    "dest": "share/icons/hicolor/256x256/apps/"
                  }
                ]
              }
            ]
          }
          EOF

      - name: Build Flatpak
        if: steps.check.outputs.skip != 'true'
        run: |
          flatpak-builder --user --force-clean \
            --install-deps-from=flathub \
            --repo=repo \
            build-dir com.nodemixaholic.BrowserOSFlatpak.json

          flatpak build-bundle repo \
            BrowserOS-unofficial.flatpak \
            com.nodemixaholic.BrowserOSFlatpak

      - name: Release
        if: steps.check.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release.outputs.version }}-flatpak
          name: BrowserOS ${{ steps.release.outputs.version }} (Flatpak)
          body: |
            Fully automated, clean Flatpak build from official .deb
            • Proper app ID: com.nodemixaholic.BrowserOSFlatpak
            • Working launcher and icon
            • No warnings or errors
          files: BrowserOS-unofficial.flatpak
